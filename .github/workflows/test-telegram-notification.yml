name: Test Telegram Notification

on:
  workflow_dispatch:
    inputs:
      custom_message:
        description: 'Custom message (optional)'
        required: false
        type: string

jobs:
  get-latest-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      changelog: ${{ steps.get_changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get latest release
        id: get_latest_release
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            if (releases.length === 0) {
              core.setFailed('No releases found');
              return;
            }
            
            const latestRelease = releases[0];
            core.setOutput('tag_name', latestRelease.tag_name);
            core.setOutput('body', latestRelease.body);
            console.log(`Latest release: ${latestRelease.tag_name}`);
      
      - name: Set version
        id: get_version
        run: |
          TAG="${{ steps.get_latest_release.outputs.tag_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $VERSION"
          
      - name: Set changelog
        id: get_changelog
        run: |
          CHANGELOG=$(cat << 'EOF'
          ${{ steps.get_latest_release.outputs.body }}
          EOF
          )
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  test-telegram:
    runs-on: ubuntu-latest
    needs: get-latest-release
    steps:
      - name: Send test notification to Telegram group 1
        uses: appleboy/telegram-action@v0.1.1
        continue-on-error: true
        with:
          to: ${{ secrets.TELEGRAM_GROUP_ID_1 }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          debug: true
          message: |
            ${{ github.event.inputs.custom_message != '' && github.event.inputs.custom_message || '' }}
            
            🚀 Blinko ${{ needs.get-latest-release.outputs.version }} has been released!
            
            📝 Changelog:
            ${{ needs.get-latest-release.outputs.changelog }}
            
            📥 Download:
            https://github.com/${{ github.repository }}/releases/tag/${{ needs.get-latest-release.outputs.version }}

      - name: Send test notification to Telegram group 2
        uses: appleboy/telegram-action@v0.1.1
        continue-on-error: true
        with:
          to: ${{ secrets.TELEGRAM_GROUP_ID_2 }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          debug: true
          message: |
            🧪 TEST NOTIFICATION 🧪
            
            ${{ github.event.inputs.custom_message != '' && github.event.inputs.custom_message || '' }}
            
            🚀 Blinko ${{ needs.get-latest-release.outputs.version }} has been released!
            
            📝 Changelog:
            ${{ needs.get-latest-release.outputs.changelog }}
            
            📥 Download:
            https://github.com/${{ github.repository }}/releases/tag/${{ needs.get-latest-release.outputs.version }} 